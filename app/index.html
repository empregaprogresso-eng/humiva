<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, GoogleAuthProvider, 
  signInWithPopup, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
  increment,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


/* ================= FIREBASE INIT ================= */

const firebaseConfig = {
  apiKey: "AIzaSyD31derHPL34IJdbOeiSJ9l1n7n24maVR4",
  authDomain: "loterica-progresso.firebaseapp.com",
  projectId: "loterica-progresso"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();


/* ================= DOM READY ================= */

document.addEventListener("DOMContentLoaded", () => {

  const greeting = document.getElementById("greeting");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const missionContainer = document.querySelector(".mission");

  if (!greeting || !loginBtn || !logoutBtn || !missionContainer) {
    console.error("Elementos do DOM n√£o encontrados.");
    return;
  }

  loginBtn.onclick = () => signInWithPopup(auth, provider);
  logoutBtn.onclick = () => signOut(auth);


  onAuthStateChanged(auth, async (user) => {

    if (!user) {
      greeting.innerHTML = "Welcome to HUMIVA";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      return;
    }

    greeting.innerHTML = "Good morning, <strong>" + user.displayName + "</strong>";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName,
        email: user.email,
        xp: 0,
        level: 1,
        streak: 0,
        lastMissionDate: null,
        createdAt: serverTimestamp()
      });
    }

    loadMissions(missionContainer);
    loadRanking();
  });


  /* ================= MISS√ïES ================= */

  async function loadMissions(container) {

    container.innerHTML = "<h3>Global Missions</h3>";

    const snapshot = await getDocs(collection(db, "missions"));

    snapshot.forEach((docSnap) => {

      const mission = docSnap.data();
      if (!mission.active) return;

      const btn = document.createElement("button");
      btn.innerText = mission.title + " (+ " + mission.xpReward + " XP)";
      btn.style.marginTop = "10px";

      btn.onclick = () => completeMission(mission.xpReward);

      container.appendChild(btn);
    });
  }


  /* ================= XP + LEVEL + STREAK ================= */

  async function completeMission(xpReward) {

    const user = auth.currentUser;
    if (!user) return alert("Fa√ßa login primeiro.");

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.data();

    const today = new Date().toDateString();
    let newStreak = userData.streak || 0;

    if (userData.lastMissionDate !== today) {
      newStreak += 1;
    }

    await updateDoc(userRef, {
      xp: increment(xpReward),
      lastMissionDate: today,
      streak: newStreak
    });

    const updatedSnap = await getDoc(userRef);
    const xp = updatedSnap.data().xp;
    const newLevel = Math.floor(xp / 100) + 1;

    await updateDoc(userRef, { level: newLevel });

    alert("Miss√£o conclu√≠da!\nLevel: " + newLevel + "\nStreak: " + newStreak + " dias üî•");

    loadRanking();
  }


  /* ================= RANKING ================= */

  async function loadRanking() {

    const snapshot = await getDocs(collection(db, "users"));
    let users = [];

    snapshot.forEach((doc) => {
      users.push(doc.data());
    });

    users.sort((a, b) => b.xp - a.xp);

    let rankingDiv = document.getElementById("ranking");

    if (!rankingDiv) {
      rankingDiv = document.createElement("div");
      rankingDiv.id = "ranking";
      rankingDiv.style.marginTop = "30px";
      document.querySelector(".app").appendChild(rankingDiv);
    }

    rankingDiv.innerHTML = "<h3>üèÜ Global Ranking</h3>";

    users.slice(0, 5).forEach((user, index) => {
      rankingDiv.innerHTML += `
        <div style="margin-top:8px;">
          ${index + 1}. ${user.name} ‚Äî ${user.xp} XP
        </div>
      `;
    });
  }

});

</script>
